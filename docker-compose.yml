version: "3.9"
services:

  ocremix-api:
#    image: ocremix-api:latest
    build: ../ocremix-api/
    depends_on:
      - ocremix-mongo-db
    ports:
      - "5000:5000"
    environment:
      - MONGO_HOST=ocremix-mongo-db
      - MONGO_PORT=27017
      - MONGO_DATABASE=ocremix
    command: ["python", "api.py"]

  ocremix-mongo-db:
    image: mongo:latest
    ports:
     - 27017:27017

  ocremix-consumer:
    build: ../ocremix-consumer
    depends_on:
      - queue
      - ocremix-mongo-db
    environment:
      - MONGO_HOST=ocremix-mongo-db
      - MONGO_PORT=27017
      - MONGO_DATABASE=ocremix
      - RABBITMQ_HOST=queue

  ocremix-spider:
    build: ../ocremix-spider/
    volumes:
      - ocremix-html:/tmp/ocremix
    command: ["scrapy", "crawl", "ocremix"]

  ocremix-html-parser:
    build: ../ocremix-html-parser/
    volumes:
      - ocremix-html:/tmp/ocremix
    environment:
      - RABBITMQ_HOST=queue
    depends_on:
      - queue
    command: ["python", "main.py"]

  localstack:
    image: localstack/localstack
    ports:
      - "4566:4566"
      - "4571:4571"
      - "${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}"
    environment:
      - SERVICES=${SERVICES- }
      - DEBUG=${DEBUG- }
      - DATA_DIR=${DATA_DIR- }
      - PORT_WEB_UI=${PORT_WEB_UI- }
      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR- }
      - KINESIS_ERROR_PROBABILITY=${KINESIS_ERROR_PROBABILITY- }
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "${TMPDIR:-/tmp/localstack}:/tmp/localstack"

  queue:
    image: rabbitmq:3-management
    ports:
      - 5672:5672
      - 15672:15672
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "5672" ]
      interval: 5s
      timeout: 15s
      retries: 1

volumes:
  ocremix-html:
